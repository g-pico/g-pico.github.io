<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy from g-Pico</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="products.js"></script> <!-- 引用產品詳細信息文件 -->
    <script>
        async function confirmPurchase() {
        if (confirm("Are you sure you want to submit the purchase? We only support shipment in Taiwan. Please confirm your address.")) {
            try {
                await sendOrderToServer(); // 等待訂單送出
                alert("Purchase confirmed! Our team will check the transaction.");
            } catch (error) {
                console.error('Error sending order:', error);
                alert('There was an issue with your order. Please try again.');
            }
        } else {
            alert("Purchase cancelled.");
        }
        }

        function setProductDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        const product = products[`product${productId}`];

        if (product) {
            document.getElementById('productName').innerText = `Confirm from cart: ${product.name}`; // 設定產品名稱
            document.getElementById('productImage').src = product.images[0]; // 設定產品圖片
            document.getElementById('productImage').style.width = '450px'; // 設定圖片寬度
            document.getElementById('productImage').style.height = 'auto'; // 保持圖片比例
            document.getElementById('price').value = product.price; // 設定產品價格
        } else {
            console.error(`Product product${productId} not found.`);
            document.getElementById('price').value = "Unknown product";
        }
    }

    async function sendOrderToServer() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        const product = products[`product${productId}`];
        const flask_addr = `http://127.0.0.1:8080/confirm-order`
        //const flask_addr = `http://gpico-automation.hopto.org/confirm-order`


        if (product) {
            const orderDetails = {
                product_name: product.name,
                email: document.getElementById('email').value,
                amount: document.getElementById('price').value,
                shipping_address: document.getElementById('address').value
            };


            const response = await fetch(flask_addr, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderDetails)
            });

            if (!response.ok) {
                throw new Error('Failed to send order');
            }

            return response.json(); // 返回伺服器的回應
        }
    }

    window.onload = setProductDetails;
</script>
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html">g-Pico Automation home</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="products.html">Products</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="donation.html">Donation</a></li>
            </ul>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 id="productName">Seeds of a different tomorrow</h1> <!-- 動態設定產品名稱 -->
        <img src="" id="productImage" class="img-fluid mb-4" alt="Product Image"> <!-- 動態設定產品圖片 -->
        <form onsubmit="event.preventDefault(); confirmPurchase();">
            <div class="form-group">
                <label for="qrCode">Process step: <br> 
                    1. Scan the QR Code to Transfer. <br> 
                    2. Enter all the information needed and your comment at payment page.<br> 
                    <span style="color: red; font-size: 18px;">3. Please make sure to put your mail account in the comment during payment.</span><br> 
                    4. Press submit after the transfer finshed.<br> 
                    5. We will send order mail to your address as reference, and will notice after shippment is done. <br>
                    <span style="font-weight: bold; font-size: 16px;">Note: </span><br>
                    > Make sure your E-mail address and Taiwan address are correct.<br><br></label>
                <img src="path/to/qr_code.jpg" id="qrCode" class="d-block" alt="QR Code">
            </div>
            <div class="form-group">
                <label for="price">Price</label>
                <input type="text" class="form-control" id="price" readonly>
            </div>
            <div class="form-group">
                <label for="email">Buyer Email</label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="address">Shipping Address</label>
                <input type="text" class="form-control" id="address" placeholder="Enter your address" required>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center text-lg-start mt-5">
        <div class="container p-4">
            <p>&copy; 2024 g-Pico</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.amazonaws.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>